<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM & Suivi ‚Äî Application unifi√©e</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111a2e; --muted:#1a2540; --card:#121a2e;
      --text:#e7ecf7; --sub:#9fb0d1; --brand:#5aa9ff; --ok:#2dd4bf;
      --warn:#fbbf24; --danger:#ef4444; --shadow:0 8px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; background: linear-gradient(180deg, #0b1220, #0b1326 40%, #0a142a); color:var(--text);}
    header{position:sticky; top:0; z-index:10; background:rgba(11,18,32,.75); backdrop-filter:saturate(140%) blur(12px); border-bottom:1px solid rgba(255,255,255,.06);}
    .bar{display:flex; align-items:center; gap:12px; padding:14px 18px; max-width:1200px; margin:0 auto;}
    .logo{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px;}
    .logo .dot{width:12px;height:12px;border-radius:50%;background:var(--brand); box-shadow:0 0 0 4px rgba(90,169,255,.15)}
    nav{display:flex; flex-wrap:wrap; gap:6px; margin-left:18px;}
    nav button{appearance:none; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; transition:.15s transform, .15s background; font-weight:600; letter-spacing:.2px; font-size:14px;}
    nav button.active{ background:var(--brand); border-color:transparent; color:#081020; }
    nav button:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06) }
    .spacer{flex:1}
    .actions{display:flex; gap:8px}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600; font-size:14px;}
    .btn.primary{ background:var(--brand); color:#081020; border-color:transparent }
    .btn.ghost{ background:transparent }
    .wrap{ max-width:1200px; margin:22px auto; padding:0 18px 34px }
    .grid{ display:grid; gap:14px }
    .cards{ grid-template-columns: repeat(4, minmax(0, 1fr)) }
    @media (max-width:1100px){ .cards{ grid-template-columns: repeat(2, minmax(0, 1fr)) } }
    @media (max-width:640px){ .cards{ grid-template-columns: 1fr } }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); }
    .stat{ display:flex; flex-direction:column; gap:6px}
    .stat .kpi{ font-size:26px; font-weight:800; letter-spacing:.2px }
    .stat small{ color:var(--sub) }
    h2{ margin:22px 0 12px 4px; font-size:20px }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th, td{ padding:10px 12px; border-bottom:1px dashed rgba(255,255,255,.07) }
    th{ text-align:left; color:#c8d5f1; font-weight:700; letter-spacing:.2px }
    tr:hover td{ background:rgba(255,255,255,.03) }
    .tag{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:12px; font-weight:700; letter-spacing:.2px }
    .tag.ok{ background:rgba(45,212,191,.12); border-color:rgba(45,212,191,.35); color:var(--ok) }
    .tag.warn{ background:rgba(251,191,36,.12); border-color:rgba(251,191,36,.35); color:var(--warn) }
    .tag.danger{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:var(--danger) }
    .muted{ color:var(--sub) }
    .row-actions{ display:flex; gap:6px } .row-actions .btn{ padding:6px 10px; font-size:12px }
    .toolbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:6px 0 14px }
    .toolbar .filters{ display:flex; gap:8px; flex-wrap:wrap }
    input, select, textarea{ width:100%; padding:10px 12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:12px; outline:none;}
    label{ display:block; font-size:12px; color:#c8d5f1; margin:10px 2px 6px }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .three{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    .four{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px }
    @media (max-width:900px){ .two, .three, .four{ grid-template-columns:1fr } }
    .pill{ padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05) }
    .progress{ height:8px; width:100%; background:rgba(255,255,255,.08); border-radius:8px; overflow:hidden }
    .progress>span{ display:block; height:100%; background:linear-gradient(90deg, var(--brand), #7ee3ff); }
    .kanban{ display:grid; gap:14px; grid-template-columns: repeat(6, minmax(240px,1fr)); overflow:auto; padding-bottom:6px }
    .col{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:10px; min-height:140px }
    .col h3{ margin:6px 8px 10px; font-size:14px; text-transform:uppercase; letter-spacing:.3px; color:#c8d5f1 }
    .deal{ background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; margin:8px 4px }
    .deal .top{ display:flex; justify-content:space-between; gap:8px; font-weight:700 }
    .deal .meta{ font-size:12px; color:var(--sub); display:flex; flex-wrap:wrap; gap:10px; margin-top:6px }
    .empty{ color:var(--sub); font-style:italic; padding:10px }
    .muted-link{ color:#c8d5f1; text-decoration:underline; cursor:pointer }
    .pillbtn{ background:transparent; border:1px dashed rgba(255,255,255,.2); padding:8px 10px; border-radius:999px; color:var(--text); cursor:pointer }
    footer{ opacity:.6; text-align:center; padding:24px 0; font-size:12px }
    .modal{ position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; padding:20px; background:rgba(3,8,20,.6); backdrop-filter: blur(6px);}
    .modal .box{ width:min(860px, 96vw); max-height:86vh; overflow:auto; background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.1); border-radius:18px; box-shadow:var(--shadow); padding:18px;}

  /* Accessibility & interaction fixes: ensure hidden modal doesn't capture pointer events */
  .modal[aria-hidden="true"]{ display:none !important; pointer-events:none; }
  .modal[aria-hidden="false"]{ display:flex !important; pointer-events:auto; }
  /* Make sure toolbar controls accept pointer events (some overlays could block them) */
  .toolbar, .toolbar * { pointer-events:auto; }
    .modal header{ position:sticky; top:0; background:transparent; border:0 }
    .modal .head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.06) }
    .modal .head h3{ margin:0 } .modal .foot{ display:flex; justify-content:flex-end; gap:8px; margin-top:16px }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo"><div class="dot"></div> CRM & Suivi</div>
      <nav id="nav"></nav>
      <div class="spacer"></div>
      <div class="actions">
        <button class="btn ghost" id="exportBtn">Exporter</button>
        <label class="btn ghost" for="importInput">Importer</label>
        <input id="importInput" type="file" accept="application/json" style="display:none" />
        <button class="btn" id="resetBtn">R√©initialiser</button>
      </div>
    </div>
  </header>

  <a class="skip" href="#app" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;">Aller au contenu</a>
  <div class="wrap"><div id="app"></div></div>

  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="box" tabindex="-1">
      <div class="head">
        <h3 id="modalTitle">Titre</h3>
        <button class="btn" onclick="closeModal()">Fermer</button>
      </div>
      <div id="modalBody"></div>
      <div class="foot" id="modalFoot"></div>
    </div>
  </div>

  <footer>CRM & Suivi ¬∑ Front Netlify + API serverless ¬∑ v2</footer>

  <!-- Client API (Netlify Functions) loaded as ES module -->
  <script type="module" src="/src/bootstrap.js"></script>

<script>
/* =========================
   DATA LAYER (cache local)
========================= */
const STORAGE_KEY = "crm_suivi_db_v2";
const defaultDB = () => ({
  students: [],
  companies: [],
  deals: [],
  offers: [],
  placements: [],
  interactions: [],
  tasks: []
});
let db = loadDB();

/* =========================
   UTILS
========================= */
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36) }
function today(){ return new Date().toISOString().slice(0,10) }
function addDays(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10) }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)) }
function percent(n){ return clamp(Math.round(n),0,100) }
function sum(arr, fn){ return arr.reduce((a,x)=>a+(fn?fn(x):x),0) }
function avg(arr, fn){ if(!arr.length) return 0; return sum(arr, fn)/arr.length }
function byId(id){ return document.getElementById(id) }
function formatNumber(n){ return new Intl.NumberFormat('fr-FR').format(n) }
function euro(n){ return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(n||0) }
function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); try{ window.db = db; }catch(e){} }
function loadDB(){ try{ const raw=localStorage.getItem(STORAGE_KEY); const d = raw?JSON.parse(raw):defaultDB(); try{ window.db = d; }catch(e){} return d; }catch(e){ const d = defaultDB(); try{ window.db = d; }catch(e){} return d; } }

// Affiche une petite pastille quand l'app utilise le simulateur local (offline)
// simulator mode removed ‚Äî UI badge no longer used

function tag(cls, text){ return `<span class="tag ${cls||''}">${text}</span>` }
function statusTag(status){
  const map = { "Nouveau":"warn", "Contact√©":"warn", "Qualifi√©":"ok", "Proposition":"warn", "N√©gociation":"warn", "Gagn√©":"ok", "Perdu":"danger" };
  return tag(map[status]||"", status||"");
}
function employabilityStatus(s){
  const c=s.coaching||{cv:{progress:0},linkedin:{progress:0},interview:{progress:0}};
  const ready = (c.cv.progress>=100 && c.linkedin.progress>=100 && c.interview.progress>=100);
  if(ready) return tag("ok","Pr√™t");
  const mean = Math.round((c.cv.progress + c.linkedin.progress + c.interview.progress)/3);
  if(mean>=60) return tag("warn","En cours");
  return tag("", "√Ä accompagner");
}
function companyById(id){ return db.companies.find(c=>c.id===id)||null }
function studentById(id){ return db.students.find(s=>s.id===id)||null }
function dealById(id){ return db.deals.find(d=>d.id===id)||null }
function offerById(id){ return db.offers.find(o=>o.id===id)||null }
function placementById(id){ return db.placements.find(p=>p.id===id)||null }

/* =========================
   NAV
========================= */
const VIEWS = [
  {id:"dashboard", label:"üè† Dashboard"},
  {id:"students", label:"üéì √âtudiants"},
  {id:"companies", label:"üè¢ Entreprises"},
  {id:"offers", label:"üíº Offres & Placements"},
  {id:"pipeline", label:"üìä Pipeline Com"},
  {id:"tasks", label:"‚úÖ T√¢ches"},
  {id:"history", label:"üìù Historique"}
];
let currentView = "dashboard";
function renderNav(){ byId('nav').innerHTML = VIEWS.map(v=>`<button class="${v.id===currentView?'active':''}" onclick="go('${v.id}')">${v.label}</button>`).join("") }
function go(id){ currentView=id; renderNav(); route(); }

/* =========================
   ROUTER
========================= */
function route(){
  const root = byId('app');
  if(currentView==="dashboard") return renderDashboard(root);
  if(currentView==="students")  return renderStudents(root);
  if(currentView==="companies") return renderCompanies(root);
  if(currentView==="offers")    return renderOffersPlacements(root);
  if(currentView==="pipeline")  return renderPipeline(root);
  if(currentView==="tasks")     return renderTasks(root);
  if(currentView==="history")   return renderHistory(root);
}

/* =========================
   DASHBOARD
========================= */
function renderDashboard(root){
  const totalStudents = db.students.length;
  const avgEmploy = Math.round(avg(db.students, s => {
    const c=s.coaching||{cv:{progress:0},linkedin:{progress:0},interview:{progress:0}};
    return (c.cv.progress + c.linkedin.progress + c.interview.progress)/3;
  }));
  const ready = db.students.filter(s => {
    const c=s.coaching||{cv:{progress:0},linkedin:{progress:0},interview:{progress:0}};
    return c.cv.progress>=100 && c.linkedin.progress>=100 && c.interview.progress>=100;
  }).length;

  const totalCompanies = db.companies.length;
  const openOffers = db.offers.filter(o=>o.status==="Ouverte").length;
  const totalSpots = sum(db.offers.filter(o=>o.status==="Ouverte"), o=>o.spots||0);

  const byStatus = (status) => sum(db.deals.filter(d=>d.status===status), d=>d.dealValue||0);
  const pipelineValue = sum(db.deals, d=>d.dealValue||0);
  const weighted = sum(db.deals, d=>(d.dealValue||0)*((d.probability||0)/100));
  const placed = db.placements.length;

  root.innerHTML = `
    <div class="grid cards">
      <div class="card stat"><div>√âtudiants suivis</div><div class="kpi">${totalStudents}</div><small>${ready} ‚Äúpr√™ts √† l‚Äôemploi‚Äù</small></div>
      <div class="card stat"><div>Employabilit√© moyenne</div><div class="kpi">${percent(avgEmploy)}%</div><div class="progress"><span style="width:${percent(avgEmploy)}%"></span></div></div>
      <div class="card stat"><div>Entreprises</div><div class="kpi">${totalCompanies}</div><small>Consolide les relations</small></div>
      <div class="card stat"><div>Offres ouvertes</div><div class="kpi">${openOffers}</div><small>${totalSpots} postes</small></div>
      <div class="card stat"><div>Pipeline (valeur)</div><div class="kpi">${euro(pipelineValue)}</div><small>Pond√©r√©: ${euro(Math.round(weighted))}</small></div>
      <div class="card stat"><div>En N√©gociation</div><div class="kpi">${euro(byStatus("N√©gociation"))}</div><small>Qualifi√©: ${euro(byStatus("Qualifi√©"))}</small></div>
      <div class="card stat"><div>Placements</div><div class="kpi">${placed}</div><small>Suivi des affectations</small></div>
      <div class="card stat"><div>Historique</div><div class="kpi">Journal</div><small><span class="muted-link" onclick="go('history')">Voir</span></small></div>
    </div>
  `;
}

/* =========================
   STUDENTS (API)
========================= */
async function renderStudents(root){
  if(!renderStudents._hydrated){
    try{ const remote = await API.get('students'); if(Array.isArray(remote)) { db.students = remote; saveDB(); } }
    catch(e){ console.warn('API students error', e); }
    renderStudents._hydrated = true;
  }
  root.innerHTML = `
    <div class="toolbar">
      <div class="filters"><input id="stuSearch" placeholder="Rechercher (nom, email)..." oninput="renderStudents(byId('app'))"></div>
      <div><button class="btn primary" onclick="openAddStudent()">+ Ajouter</button></div>
    </div>
    <div class="card">
      <table>
        <thead><tr><th>√âtudiant</th><th>Contact</th><th>Employabilit√©</th><th>Statut</th><th>MAJ</th><th></th></tr></thead>
        <tbody id="studentsRows"></tbody>
      </table>
    </div>
  `;
  const q=(byId('stuSearch')?.value||"").toLowerCase();
  const rows = db.students.filter(s=> !q || s.name?.toLowerCase().includes(q) || (s.email||"").toLowerCase().includes(q) ).map(s=>{
    const c=s.coaching||{cv:{progress:0},linkedin:{progress:0},interview:{progress:0}, lastUpdate:""};
    const mean = percent((c.cv.progress + c.linkedin.progress + c.interview.progress)/3);
    return `<tr>
      <td>${s.name||""}</td>
      <td class="muted">${s.email||""}<br>${s.phone||""}</td>
      <td style="min-width:180px"><div class="progress"><span style="width:${mean}%"></span></div></td>
      <td>${employabilityStatus(s)}</td>
      <td class="muted">${c.lastUpdate||""}</td>
      <td class="row-actions">
        <button class="btn" onclick="viewStudent('${s.id}')">Voir</button>
        <button class="btn" onclick="openEditStudent('${s.id}')">√âditer</button>
        <button class="btn" onclick="deleteStudent('${s.id}')">Suppr.</button>
      </td>
    </tr>`
  }).join("");
  byId('studentsRows').innerHTML = rows || `<tr><td colspan="6" class="empty">Aucun √©tudiant</td></tr>`;
}
function viewStudent(id){
  const s = studentById(id); if(!s) return;
  openModal("Fiche ‚Äî " + (s.name||""), `
    <div class="two">
      <div>
        <label>Nom</label><div class="pill">${s.name||"‚Äî"}</div>
        <label>Email</label><div class="pill">${s.email||"‚Äî"}</div>
        <label>T√©l√©phone</label><div class="pill">${s.phone||"‚Äî"}</div>
      </div>
      <div>
        <label>Employabilit√©</label>
        <div class="progress"><span style="width:${percent(((s.coaching?.cv?.progress||0)+(s.coaching?.linkedin?.progress||0)+(s.coaching?.interview?.progress||0))/3)}%"></span></div>
        <div style="margin-top:6px">${employabilityStatus(s)}</div>
      </div>
    </div>
    <h2>Coaching</h2>
    <div class="three">
      ${coachingBlock("CV", s.coaching?.cv||{progress:0,status:"",notes:""})}
      ${coachingBlock("LinkedIn", s.coaching?.linkedin||{progress:0,status:"",notes:""})}
      ${coachingBlock("Entretien", s.coaching?.interview||{progress:0,status:"",notes:""})}
    </div>
  `, `<button class="btn" onclick="openEditStudent('${s.id}')">Mettre √† jour</button>`);
}
function coachingBlock(title, obj){
  return `<div class="card">
    <strong>${title}</strong>
    <div class="progress" style="margin-top:6px"><span style="width:${percent(obj.progress||0)}%"></span></div>
    <div class="muted" style="margin-top:6px">${obj.status||""}</div>
    <div class="muted" style="margin-top:6px"><em>${obj.notes||""}</em></div>
  </div>`;
}
function openAddStudent(){
  openModal("Ajouter un √©tudiant", `
    <div class="two">
      <div><label>Nom</label><input id="s_name"></div>
      <div><label>Email</label><input id="s_email"></div>
      <div><label>T√©l√©phone</label><input id="s_phone"></div>
    </div>
  `, `<button class="btn primary" onclick="saveNewStudent()">Enregistrer</button>`);
}
async function saveNewStudent(){
  const payload = {
    name: byId('s_name').value.trim(),
    email: byId('s_email').value.trim(),
    phone: byId('s_phone').value.trim(),
    coaching:{
      cv:{status:"√Ä commencer", progress:0, notes:""},
      linkedin:{status:"√Ä commencer", progress:0, notes:""},
      interview:{status:"√Ä commencer", progress:0, notes:""},
      lastUpdate: today()
    }
  };
  if(!payload.name){ alert("Nom requis"); return; }
  const created = await API.post('students', payload);
  if(created?.id){
    if(!db.students.find(s=>s.id===created.id)) db.students.push(created);
    saveDB();
  }
  closeModal(); route();
}
function openEditStudent(id){
  const s = studentById(id); if(!s) return;
  const c=s.coaching||{cv:{},linkedin:{},interview:{}};
  openModal("√âditer ‚Äî "+(s.name||""), `
    <div class="two">
      <div><label>Nom</label><input id="s_name" value="${s.name||""}"></div>
      <div><label>Email</label><input id="s_email" value="${s.email||""}"></div>
      <div><label>T√©l√©phone</label><input id="s_phone" value="${s.phone||""}"></div>
    </div>
    <h2>Coaching</h2>
    <div class="three">
      ${editCoachBlock("cv", c.cv||{})}
      ${editCoachBlock("linkedin", c.linkedin||{})}
      ${editCoachBlock("interview", c.interview||{})}
    </div>
  `, `<button class="btn primary" onclick="saveEditStudent('${s.id}')">Enregistrer</button>`);
}
function editCoachBlock(key, obj){
  return `<div class="card">
    <strong>${key.toUpperCase()}</strong>
    <label>Statut</label><input id="${key}_status" value="${obj.status||""}">
    <label>Progression (%)</label><input id="${key}_progress" type="number" min="0" max="100" value="${percent(obj.progress||0)}">
    <label>Notes</label><textarea id="${key}_notes">${obj.notes||""}</textarea>
  </div>`;
}
async function saveEditStudent(id){
  const s = studentById(id); if(!s) return;
  const patch = {
    name: byId('s_name').value.trim(),
    email: byId('s_email').value.trim(),
    phone: byId('s_phone').value.trim(),
    coaching: {
      cv:{ status: byId('cv_status').value, progress: clamp(parseInt(byId('cv_progress').value||"0",10),0,100), notes: byId('cv_notes').value },
      linkedin:{ status: byId('linkedin_status').value, progress: clamp(parseInt(byId('linkedin_progress').value||"0",10),0,100), notes: byId('linkedin_notes').value },
      interview:{ status: byId('interview_status').value, progress: clamp(parseInt(byId('interview_progress').value||"0",10),0,100), notes: byId('interview_notes').value },
      lastUpdate: today()
    }
  };
  const updated = await API.patch('students', { id, ...patch });
  Object.assign(s, updated); saveDB(); closeModal(); route();
}
async function deleteStudent(id){
  if(!confirm("Supprimer cet √©tudiant ?")) return;
  await API.del('students', { id });
  db.students = db.students.filter(x=>x.id!==id);
  // Nettoyage local placement/t√¢ches li√©s (placements restent locaux)
  db.placements = db.placements.filter(p=>p.studentId!==id);
  db.tasks = db.tasks.filter(t=>t.studentId!==id);
  saveDB(); route();
}

/* =========================
   COMPANIES (API)
========================= */
async function renderCompanies(root){
  if(!renderCompanies._hydrated){
    try{ const remote = await API.get('companies'); if(Array.isArray(remote)){ db.companies = remote; saveDB(); } }
    catch(e){ console.warn('API companies error', e); }
    renderCompanies._hydrated = true;
  }
  root.innerHTML = `
    <div class="toolbar">
      <div class="filters">
        <input id="compSearch" placeholder="Rechercher (nom, secteur, ville‚Ä¶)" oninput="renderCompanies(byId('app'))">
        <select id="compStatus" onchange="renderCompanies(byId('app'))">
          <option value="">‚Äî Statut relation ‚Äî</option>
          <option>Partenaire actif</option><option>Potentiel</option><option>Premier contact</option>
        </select>
      </div>
      <div><button class="btn primary" onclick="openAddCompany()">+ Ajouter</button></div>
    </div>
    <div class="card">
      <table>
        <thead><tr><th>Entreprise</th><th>Relation</th><th>Capacit√©</th><th>Convention</th><th>Dernier contact</th><th></th></tr></thead>
        <tbody id="companiesRows"></tbody>
      </table>
    </div>
  `;
  const q=(byId('compSearch')?.value||"").toLowerCase();
  const st=(byId('compStatus')?.value||"");
  const rows = db.companies.filter(c=>{
    const hit=!q || c.name?.toLowerCase().includes(q) || (c.sector||"").toLowerCase().includes(q) || (c.address||"").toLowerCase().includes(q);
    const ok=!st || (c.status===st); return hit && ok;
  }).map(c=>`<tr>
      <td>${c.name||""}<div class="muted">${c.sector||""} ¬∑ ${c.size||""} ¬∑ ${c.address||""}</div></td>
      <td>${c.status?tag(c.status.includes("actif")?"ok":"warn", c.status):""} ${c.relationLevel?`¬∑ <span class="muted">${c.relationLevel}</span>`:""}</td>
      <td>${c.capacity||0} places ¬∑ ${c.placedStudents||0} plac√©s</td>
      <td>${c.conventionSigned?tag("ok","Sign√©e"):tag("warn","√Ä signer")}</td>
      <td class="muted">${c.lastContactDate||"‚Äî"}</td>
      <td class="row-actions">
        <button class="btn" onclick="viewCompany('${c.id}')">Voir</button>
        <button class="btn" onclick="openEditCompany('${c.id}')">√âditer</button>
        <button class="btn" onclick="deleteCompany('${c.id}')">Suppr.</button>
      </td>
    </tr>`).join("");
  byId('companiesRows').innerHTML = rows || `<tr><td colspan="6" class="empty">Aucune entreprise</td></tr>`;
}
function viewCompany(id){
  const c = companyById(id); if(!c) return;
  const deals = db.deals.filter(d=>d.companyId===id);
  const offers = db.offers.filter(o=>o.companyId===id);
  const placements = db.placements.filter(p=>p.companyId===id); // local
  openModal("Entreprise ‚Äî "+(c.name||""), `
    <div class="two">
      <div>
        <div class="muted">${c.sector||""} ¬∑ ${c.size||""}</div>
        <div class="muted">${c.address||""}</div>
        <div style="margin-top:6px">${c.status?tag(c.status.includes("actif")?"ok":"warn", c.status):""} ${c.relationLevel?`¬∑ <span class="muted">${c.relationLevel}</span>`:""}</div>
        <div style="margin-top:6px">Capacit√©: <strong>${c.capacity||0}</strong> ¬∑ Plac√©s: <strong>${c.placedStudents||0}</strong></div>
        <div style="margin-top:6px">Convention: ${c.conventionSigned?tag("ok","Sign√©e"):tag("warn","√Ä signer")}</div>
        <div class="row-actions" style="margin-top:10px">
          <button class="btn" onclick="openAddOffer('${c.id}')">+ Offre</button>
          <button class="btn" onclick="openAddDeal('${c.id}')">+ Opportunit√©</button>
          <button class="btn" onclick="openAddInteraction('${c.id}')">+ Interaction</button>
        </div>
      </div>
      <div>
        <label>Site</label>${c.website?`<a class="muted-link" href="${c.website}" target="_blank">${c.website}</a>`:"‚Äî"}
        <label style="margin-top:10px">Dernier contact</label><div class="pill">${c.lastContactDate||"‚Äî"}</div>
        <label style="margin-top:10px">Notes</label><div class="pill">${c.notes||"‚Äî"}</div>
      </div>
    </div>
    <h2>Opportunit√©s</h2>
    ${deals.length? deals.map(d=>dealCard(d)).join("") : `<div class="empty">Aucune opportunit√©</div>`}
    <h2>Offres</h2>
    ${offers.length? offers.map(o=>offerCard(o)).join("") : `<div class="empty">Aucune offre</div>`}
    <h2>Placements</h2>
    ${placements.length? placements.map(p=>placementLine(p)).join("") : `<div class="empty">Aucun placement</div>`}
  `, ``);
}
function openAddCompany(){
  openModal("Ajouter une entreprise", `
    <div class="two">
      <div><label>Nom</label><input id="c_name" placeholder="Raison sociale"></div>
      <div><label>Secteur</label><input id="c_sector"></div>
      <div><label>Taille</label><input id="c_size" placeholder="ex: 50-100"></div>
      <div><label>Adresse</label><input id="c_addr"></div>
      <div><label>Site</label><input id="c_site" placeholder="https://..."></div>
      <div><label>Statut relation</label>
        <select id="c_status"><option>Partenaire actif</option><option>Potentiel</option><option>Premier contact</option></select>
      </div>
      <div><label>Niveau relation</label><input id="c_rel" placeholder="Excellent / √Ä d√©velopper‚Ä¶"></div>
      <div><label>Convention sign√©e ?</label><select id="c_conv"><option value="true">Oui</option><option value="false">Non</option></select></div>
      <div><label>Capacit√© d‚Äôaccueil</label><input id="c_cap" type="number" min="0" value="0"></div>
      <div><label>Dernier contact</label><input id="c_last" type="date" value="${today()}"></div>
    </div>
  `, `<button class="btn primary" onclick="saveCompany()">Enregistrer</button>`);
}
async function saveCompany(){
  const payload = {
    name: byId('c_name').value.trim(),
    sector: byId('c_sector').value.trim(),
    size: byId('c_size').value.trim(),
    address: byId('c_addr').value.trim(),
    website: byId('c_site').value.trim(),
    status: byId('c_status').value,
    relationLevel: byId('c_rel').value.trim(),
    conventionSigned: byId('c_conv').value==="true",
    capacity: parseInt(byId('c_cap').value||"0",10),
    placedStudents: 0,
    lastContactDate: byId('c_last').value
  };
  if(!payload.name){ alert("Nom requis"); return; }
  const created = await API.post('companies', payload);
  if(created?.id){
    if(!db.companies.find(c=>c.id===created.id)) db.companies.push(created);
    saveDB();
  }
  closeModal(); route();
}
function openEditCompany(id){
  const c = companyById(id); if(!c) return;
  openModal("√âditer ‚Äî "+(c.name||""), `
    <div class="two">
      <div><label>Nom</label><input id="c_name" value="${c.name||""}"></div>
      <div><label>Secteur</label><input id="c_sector" value="${c.sector||""}"></div>
      <div><label>Taille</label><input id="c_size" value="${c.size||""}"></div>
      <div><label>Adresse</label><input id="c_addr" value="${c.address||""}"></div>
      <div><label>Site</label><input id="c_site" value="${c.website||""}"></div>
      <div><label>Statut relation</label>
        <select id="c_status">${["Partenaire actif","Potentiel","Premier contact"].map(o=>`<option ${o===c.status?'selected':''}>${o}</option>`).join("")}</select>
      </div>
      <div><label>Niveau relation</label><input id="c_rel" value="${c.relationLevel||""}"></div>
      <div><label>Convention sign√©e ?</label>
        <select id="c_conv"><option value="true" ${c.conventionSigned?'selected':''}>Oui</option><option value="false" ${!c.conventionSigned?'selected':''}>Non</option></select>
      </div>
      <div><label>Capacit√© d‚Äôaccueil</label><input id="c_cap" type="number" value="${c.capacity||0}"></div>
      <div><label>Dernier contact</label><input id="c_last" type="date" value="${c.lastContactDate||today()}"></div>
    </div>
  `, `<button class="btn primary" onclick="saveEditCompany('${c.id}')">Enregistrer</button>`);
}
async function saveEditCompany(id){
  const patch = {
    name: byId('c_name').value.trim(),
    sector: byId('c_sector').value.trim(),
    size: byId('c_size').value.trim(),
    address: byId('c_addr').value.trim(),
    website: byId('c_site').value.trim(),
    status: byId('c_status').value,
    relationLevel: byId('c_rel').value.trim(),
    conventionSigned: byId('c_conv').value==="true",
    capacity: parseInt(byId('c_cap').value||"0",10),
    lastContactDate: byId('c_last').value
  };
  const updated = await API.patch('companies', { id, ...patch });
  const c = companyById(id); if(c) Object.assign(c, updated);
  saveDB(); closeModal(); route();
}
async function deleteCompany(id){
  if(!confirm("Supprimer cette entreprise ?")) return;
  await API.del('companies', { id });
  // Nettoyage local (offres/deals li√©s)
  db.offers = db.offers.filter(o=>o.companyId!==id);
  db.deals  = db.deals.filter(d=>d.companyId!==id);
  db.placements = db.placements.filter(p=>p.companyId!==id); // local
  db.companies = db.companies.filter(c=>c.id!==id);
  saveDB(); route();
}

/* =========================
   OFFERS (API) + PLACEMENTS (local)
========================= */
async function renderOffersPlacements(root){
  // Hydrate offres depuis API
  if(!renderOffersPlacements._hydrated){
    try{ const remote = await API.get('offers'); if(Array.isArray(remote)) { db.offers = remote; saveDB(); } }
    catch(e){ console.warn('API offers error', e); }
    renderOffersPlacements._hydrated = true;
  }
  root.innerHTML = `
    <div class="toolbar">
      <div class="filters">
        <select id="tabOP" onchange="renderOffersPlacements(byId('app'))">
          <option value="offers">Offres</option>
          <option value="placements">Placements</option>
        </select>
      </div>
      <div id="opActions"></div>
    </div>
    <div class="card" id="opContent"></div>
  `;
  const tab = byId('tabOP').value;
  const actions = byId('opActions'); const cont = byId('opContent');
  if(tab==="offers"){
    actions.innerHTML = `<button class="btn primary" onclick="openAddOffer()">+ Nouvelle offre</button>`;
    cont.innerHTML = `
      <table>
        <thead><tr><th>Intitul√©</th><th>Entreprise</th><th>Type</th><th>D√©but</th><th>Places</th><th>Statut</th><th></th></tr></thead>
        <tbody id="offersRows"></tbody>
      </table>`;
    const rows = db.offers.map(o=>{
      const c = companyById(o.companyId);
      return `<tr>
        <td>${o.title}<div class="muted">${o.domain||""}</div></td>
        <td>${c?c.name:"‚Äî"}</td>
        <td>${o.type||""}</td>
        <td>${o.startDate||"‚Äî"}</td>
        <td>${o.spots||0}</td>
        <td>${o.status||""}</td>
        <td class="row-actions">
          <button class="btn" onclick="matchStudents('${o.id}')">Matcher</button>
          <button class="btn" onclick="openEditOffer('${o.id}')">√âditer</button>
          <button class="btn" onclick="deleteOffer('${o.id}')">Suppr.</button>
        </td>
      </tr>`;
    }).join("");
    byId('offersRows').innerHTML = rows || `<tr><td colspan="7" class="empty">Aucune offre</td></tr>`;
  } else {
    actions.innerHTML = `<button class="btn primary" onclick="openAddPlacement()">+ Nouveau placement</button>`;
    cont.innerHTML = `
      <table>
        <thead><tr><th>√âtudiant</th><th>Entreprise</th><th>Poste</th><th>Type</th><th>Dates</th><th></th></tr></thead>
        <tbody id="plRows"></tbody>
      </table>`;
    const rows = db.placements.map(p=>{
      const s=studentById(p.studentId), c=companyById(p.companyId);
      return `<tr>
        <td>${s?s.name:"‚Äî"}</td><td>${c?c.name:"‚Äî"}</td>
        <td>${p.position||""}</td><td>${p.contractType||""}</td>
        <td>${p.startDate||""} ‚Üí ${p.endDate||""}</td>
        <td class="row-actions"><button class="btn" onclick="deletePlacement('${p.id}')">Suppr.</button></td>
      </tr>`;
    }).join("");
    byId('plRows').innerHTML = rows || `<tr><td colspan="6" class="empty">Aucun placement</td></tr>`;
  }
}
function openAddOffer(companyId){
  const compOpts = db.companies.map(c=>`<option value="${c.id}" ${companyId===c.id?'selected':''}>${c.name}</option>`).join("");
  openModal("Ajouter une offre", `
    <div class="two">
      <div><label>Entreprise</label><select id="o_company">${compOpts}</select></div>
      <div><label>Intitul√©</label><input id="o_title" placeholder="Ex: Assistant Marketing"></div>
      <div><label>Type</label><select id="o_type"><option>Alternance</option><option>Stage</option><option>CDI</option><option>CDD</option></select></div>
      <div><label>Domaine</label><input id="o_domain" placeholder="Marketing / Data / Sales‚Ä¶"></div>
      <div><label>Dur√©e</label><input id="o_duration" placeholder="12 mois"></div>
      <div><label>Places</label><input id="o_spots" type="number" min="1" value="1"></div>
      <div><label>D√©but</label><input id="o_start" type="date" value="${today()}"></div>
      <div><label>Statut</label><select id="o_status"><option>Ouverte</option><option>Ferm√©e</option></select></div>
      <div><label>Notes</label><textarea id="o_notes"></textarea></div>
    </div>
  `, `<button class="btn primary" onclick="saveOffer()">Enregistrer</button>`);
}
async function saveOffer(){
  const payload = {
    companyId: byId('o_company').value,
    title: byId('o_title').value.trim(),
    type: byId('o_type').value,
    domain: byId('o_domain').value.trim(),
    duration: byId('o_duration').value.trim(),
    spots: parseInt(byId('o_spots').value||"1",10),
    startDate: byId('o_start').value,
    status: byId('o_status').value,
    notes: byId('o_notes').value.trim()
  };
  if(!payload.companyId || !payload.title){ alert("Entreprise et intitul√© requis"); return; }
  const created = await API.post('offers', payload);
  if(created?.id){
    if(!db.offers.find(o=>o.id===created.id)) db.offers.push(created);
    saveDB();
  }
  closeModal(); route();
}
function openEditOffer(id){
  const o = offerById(id); if(!o) return;
  const compOpts = db.companies.map(c=>`<option value="${c.id}" ${o.companyId===c.id?'selected':''}>${c.name}</option>`).join("");
  openModal("√âditer l‚Äôoffre", `
    <div class="two">
      <div><label>Entreprise</label><select id="o_company">${compOpts}</select></div>
      <div><label>Intitul√©</label><input id="o_title" value="${o.title}"></div>
      <div><label>Type</label><select id="o_type">${["Alternance","Stage","CDI","CDD"].map(x=>`<option ${o.type===x?'selected':''}>${x}</option>`)}</select></div>
      <div><label>Domaine</label><input id="o_domain" value="${o.domain||""}"></div>
      <div><label>Dur√©e</label><input id="o_duration" value="${o.duration||""}"></div>
      <div><label>Places</label><input id="o_spots" type="number" value="${o.spots||1}"></div>
      <div><label>D√©but</label><input id="o_start" type="date" value="${o.startDate||today()}"></div>
      <div><label>Statut</label><select id="o_status">${["Ouverte","Ferm√©e"].map(x=>`<option ${o.status===x?'selected':''}>${x}</option>`)}</select></div>
      <div><label>Notes</label><textarea id="o_notes">${o.notes||""}</textarea></div>
    </div>
  `, `<button class="btn primary" onclick="saveEditOffer('${o.id}')">Enregistrer</button>`);
}
async function saveEditOffer(id){
  const patch = {
    companyId: byId('o_company').value,
    title: byId('o_title').value.trim(),
    type: byId('o_type').value,
    domain: byId('o_domain').value.trim(),
    duration: byId('o_duration').value.trim(),
    spots: parseInt(byId('o_spots').value||"1",10),
    startDate: byId('o_start').value,
    status: byId('o_status').value,
    notes: byId('o_notes').value.trim()
  };
  const updated = await API.patch('offers', { id, ...patch });
  const o = offerById(id); if(o) Object.assign(o, updated);
  saveDB(); closeModal(); route();
}
async function deleteOffer(id){
  if(!confirm("Supprimer cette offre ?")) return;
  await API.del('offers', { id });
  db.offers = db.offers.filter(x=>x.id!==id);
  saveDB(); route();
}
function matchStudents(offerId){
  const o = offerById(offerId); if(!o) return;
  const candidates = db.students.filter(s => (s.coaching?.cv?.progress||0)>=70 && (s.coaching?.linkedin?.progress||0)>=60);
  openModal("Matcher ‚Äî " + o.title, `
    <div class="muted">Candidats propos√©s (CV ‚â•70% & LinkedIn ‚â•60%)</div>
    <table style="margin-top:10px">
      <thead><tr><th>√âtudiant</th><th>Employabilit√©</th><th></th></tr></thead>
      <tbody>
        ${candidates.map(s=>{
          const mean = percent(((s.coaching?.cv?.progress||0)+(s.coaching?.linkedin?.progress||0)+(s.coaching?.interview?.progress||0))/3);
          return `<tr>
            <td>${s.name}</td>
            <td style="min-width:160px"><div class="progress"><span style="width:${mean}%"></span></div></td>
            <td><button class="btn" onclick="createPlacementFromOffer('${s.id}','${o.id}')">Cr√©er un placement</button></td>
          </tr>`;
        }).join("")}
      </tbody>
    </table>
  `, ``);
}
function createPlacementFromOffer(studentId, offerId){
  const o = offerById(offerId); if(!o) return;
  const s = studentById(studentId); if(!s) return;
  const c = companyById(o.companyId); if(!c) return;
  const p = { id: uid(), studentId, companyId:o.companyId, position:o.title, contractType:o.type, startDate:o.startDate, endDate:"" };
  db.placements.push(p);
  saveDB();
  alert("Placement (local) cr√©√© pour " + s.name + " chez " + c.name);
  closeModal();
}
function openAddPlacement(){
  const stuOpts = db.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  const compOpts = db.companies.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
  openModal("Nouveau placement (local)", `
    <div class="two">
      <div><label>√âtudiant</label><select id="pl_stu">${stuOpts}</select></div>
      <div><label>Entreprise</label><select id="pl_company">${compOpts}</select></div>
      <div><label>Poste</label><input id="pl_position"></div>
      <div><label>Type</label><select id="pl_type"><option>Alternance</option><option>Stage</option><option>CDI</option><option>CDD</option></select></div>
      <div><label>D√©but</label><input id="pl_start" type="date" value="${today()}"></div>
      <div><label>Fin</label><input id="pl_end" type="date"></div>
    </div>
  `, `<button class="btn primary" onclick="saveManualPlacement()">Cr√©er</button>`);
}
function saveManualPlacement(){
  const p = {
    id: uid(),
    studentId: byId('pl_stu').value,
    companyId: byId('pl_company').value,
    position: byId('pl_position').value,
    contractType: byId('pl_type').value,
    startDate: byId('pl_start').value,
    endDate: byId('pl_end').value
  };
  if(!p.studentId || !p.companyId || !p.position){ alert("Champs requis manquants"); return; }
  db.placements.push(p); saveDB(); closeModal(); route();
}
function deletePlacement(id){
  if(!confirm("Supprimer ce placement (local) ?")) return;
  db.placements = db.placements.filter(x=>x.id!==id); saveDB(); route();
}

/* =========================
   PIPELINE / DEALS (API)
========================= */
const PIPE_STEPS = ["Nouveau","Contact√©","Qualifi√©","Proposition","N√©gociation","Gagn√©","Perdu"];
async function renderPipeline(root){
  if(!renderPipeline._hydrated){
    try{ const remote = await API.get('deals'); if(Array.isArray(remote)){ db.deals = remote; saveDB(); } }
    catch(e){ console.warn('API deals error', e); }
    renderPipeline._hydrated = true;
  }
  root.innerHTML = `
    <div class="toolbar">
      <div class="filters"><button class="btn" onclick="openAddDeal()">+ Nouvelle opportunit√©</button></div>
      <div class="muted">Valeur: <strong>${euro(sum(db.deals,d=>d.dealValue||0))}</strong> ¬∑ Pond√©r√©e: <strong>${euro(Math.round(sum(db.deals,d=>(d.dealValue||0)*((d.probability||0)/100))) )}</strong></div>
    </div>
    <div class="kanban" id="kanban"></div>
  `;
  const board = byId('kanban');
  board.innerHTML = PIPE_STEPS.map(step=>{
    const deals = db.deals.filter(d=>d.status===step);
    const total = sum(deals, d=>d.dealValue||0);
    return `<div class="col"><h3>${step} ¬∑ ${euro(total)}</h3>${deals.length? deals.map(d=>dealCard(d)).join(""):`<div class="empty">Aucune carte</div>`}</div>`;
  }).join("");
}
function dealCard(d){
  const c = companyById(d.companyId);
  return `<div class="deal">
    <div class="top"><div>${c?c.name:"‚Äî"}</div><div>${statusTag(d.status)}</div></div>
    <div class="meta"><div>Valeur: <strong>${euro(d.dealValue||0)}</strong></div><div>Proba: <strong>${d.probability||0}%</strong></div><div>Close: ${d.expectedCloseDate||"‚Äî"}</div></div>
    <div class="row-actions" style="margin-top:8px">
      <button class="btn" onclick="openEditDeal('${d.id}')">√âditer</button>
      <button class="btn" onclick="deleteDeal('${d.id}')">Suppr.</button>
    </div>
  </div>`;
}
function openAddDeal(companyId){
  const compOpts = db.companies.map(c=>`<option value="${c.id}" ${companyId===c.id?'selected':''}>${c.name}</option>`).join("");
  openModal("Nouvelle opportunit√©", `
    <div class="two">
      <div><label>Entreprise</label><select id="d_company"><option value="">‚Äî</option>${compOpts}</select></div>
      <div><label>Contact principal</label><input id="d_contact" placeholder="Nom"></div>
      <div><label>Poste</label><input id="d_position" placeholder="DRH, CEO‚Ä¶"></div>
      <div><label>Email</label><input id="d_email"></div>
      <div><label>T√©l√©phone</label><input id="d_phone"></div>
      <div><label>Source</label><input id="d_source" placeholder="LinkedIn / salon‚Ä¶"></div>
      <div><label>Statut</label><select id="d_status">${PIPE_STEPS.map(s=>`<option>${s}</option>`)}</select></div>
      <div><label>Priorit√©</label><select id="d_priority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select></div>
      <div><label>Valeur (‚Ç¨)</label><input id="d_value" type="number" value="0"></div>
      <div><label>Probabilit√© (%)</label><input id="d_prob" type="number" value="20" min="0" max="100"></div>
      <div><label>Closing pr√©vu</label><input id="d_close" type="date" value="${addDays(30)}"></div>
      <div><label>Notes</label><textarea id="d_notes"></textarea></div>
    </div>
  `, `<button class="btn primary" onclick="saveDeal()">Cr√©er</button>`);
}
async function saveDeal(){
  const payload = {
    companyId: byId('d_company').value || null,
    contactName: byId('d_contact').value.trim(),
    contactPosition: byId('d_position').value.trim(),
    email: byId('d_email').value.trim(),
    phone: byId('d_phone').value.trim(),
    source: byId('d_source').value.trim(),
    status: byId('d_status').value,
    priority: byId('d_priority').value,
    dealValue: parseFloat(byId('d_value').value||"0"),
    probability: parseInt(byId('d_prob').value||"0",10),
    expectedCloseDate: byId('d_close').value,
    notes: byId('d_notes').value.trim(),
    lastContactDate: today()
  };
  const created = await API.post('deals', payload);
  if(created?.id){
    if(!db.deals.find(d=>d.id===created.id)) db.deals.push(created);
    saveDB();
  }
  closeModal(); route();
}
function openEditDeal(id){
  const d = dealById(id); if(!d) return;
  const compOpts = db.companies.map(c=>`<option value="${c.id}" ${d.companyId===c.id?'selected':''}>${c.name}</option>`).join("");
  openModal("√âditer l‚Äôopportunit√©", `
    <div class="two">
      <div><label>Entreprise</label><select id="d_company"><option value="">‚Äî</option>${compOpts}</select></div>
      <div><label>Contact principal</label><input id="d_contact" value="${d.contactName||""}"></div>
      <div><label>Poste</label><input id="d_position" value="${d.contactPosition||""}"></div>
      <div><label>Email</label><input id="d_email" value="${d.email||""}"></div>
      <div><label>T√©l√©phone</label><input id="d_phone" value="${d.phone||""}"></div>
      <div><label>Source</label><input id="d_source" value="${d.source||""}"></div>
      <div><label>Statut</label><select id="d_status">${PIPE_STEPS.map(s=>`<option ${d.status===s?'selected':''}>${s}</option>`)}</select></div>
      <div><label>Priorit√©</label><select id="d_priority">${["Haute","Moyenne","Basse"].map(x=>`<option ${d.priority===x?'selected':''}>${x}</option>`)}</select></div>
      <div><label>Valeur (‚Ç¨)</label><input id="d_value" type="number" value="${d.dealValue||0}"></div>
      <div><label>Probabilit√© (%)</label><input id="d_prob" type="number" value="${d.probability||0}"></div>
      <div><label>Closing pr√©vu</label><input id="d_close" type="date" value="${d.expectedCloseDate||today()}"></div>
      <div><label>Notes</label><textarea id="d_notes">${d.notes||""}</textarea></div>
    </div>
  `, `<button class="btn primary" onclick="saveEditDeal('${d.id}')">Enregistrer</button>`);
}
async function saveEditDeal(id){
  const patch = {
    companyId: byId('d_company').value || null,
    contactName: byId('d_contact').value.trim(),
    contactPosition: byId('d_position').value.trim(),
    email: byId('d_email').value.trim(),
    phone: byId('d_phone').value.trim(),
    source: byId('d_source').value.trim(),
    status: byId('d_status').value,
    priority: byId('d_priority').value,
    dealValue: parseFloat(byId('d_value').value||"0"),
    probability: parseInt(byId('d_prob').value||"0",10),
    expectedCloseDate: byId('d_close').value,
    notes: byId('d_notes').value.trim()
  };
  const updated = await API.patch('deals', { id, ...patch });
  const d = dealById(id); if(d) Object.assign(d, updated);
  saveDB(); closeModal(); route();
}
async function deleteDeal(id){
  if(!confirm("Supprimer cette opportunit√© ?")) return;
  await API.del('deals', { id });
  db.deals = db.deals.filter(x=>x.id!==id);
  saveDB(); route();
}

/* =========================
   TASKS (API)
========================= */
async function renderTasks(root){
  if(!renderTasks._hydrated){
    try{ const remote = await API.get('tasks'); if(Array.isArray(remote)){ db.tasks = remote; saveDB(); } }
    catch(e){ console.warn('API tasks error', e); }
    renderTasks._hydrated = true;
  }
  root.innerHTML = `
    <div class="toolbar">
      <div class="filters">
        <select id="t_filter" onchange="renderTasks(byId('app'))">
          <option value="all">Toutes</option>
          <option value="open">Ouvertes</option>
          <option value="done">Termin√©es</option>
        </select>
      </div>
      <div><button class="btn primary" onclick="openAddTask()">+ Nouvelle t√¢che</button></div>
    </div>
    <div class="card">
      <table>
        <thead><tr><th>T√¢che</th><th>√âch√©ance</th><th>Lien</th><th>Priorit√©</th><th>Statut</th><th></th></tr></thead>
        <tbody id="tRows"></tbody>
      </table>
    </div>
  `;
  const filter = byId('t_filter').value;
  const rows = db.tasks.filter(t=>{
    if(filter==="open") return !t.completed;
    if(filter==="done") return t.completed;
    return true;
  }).map(t=>{
    let link = "‚Äî";
    if(t.companyId){ const c = companyById(t.companyId); link = c?`Entreprise: ${c.name}`:"Entreprise: ‚Äî"; }
    if(t.dealId){ const d = dealById(t.dealId); const c = d?companyById(d.companyId):null; link = d?`Opportunit√©: ${c?c.name:""} (${d.status})`:""; }
    if(t.studentId){ const s = studentById(t.studentId); link = s?`√âtudiant: ${s.name}`:""; }
    return `<tr>
      <td>${t.title}</td>
      <td class="muted">${t.dueDate||"‚Äî"}</td>
      <td class="muted">${link}</td>
      <td>${t.priority||"‚Äî"}</td>
      <td>${t.completed?tag("ok","Termin√©"):tag("warn","Ouvert")}</td>
      <td class="row-actions">
        <button class="btn" onclick="toggleTask('${t.id}')">${t.completed?"Rouvrir":"Terminer"}</button>
        <button class="btn" onclick="deleteTask('${t.id}')">Suppr.</button>
      </td>
    </tr>`;
  }).join("");
  byId('tRows').innerHTML = rows || `<tr><td colspan="6" class="empty">Aucune t√¢che</td></tr>`;
}
function openAddTask(){
  const compOpts = `<option value="">‚Äî</option>` + db.companies.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
  const stuOpts = `<option value="">‚Äî</option>` + db.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  const dealOpts = `<option value="">‚Äî</option>` + db.deals.map(d=>{
    const name = companyById(d.companyId)?.name || "‚Äî";
    return `<option value="${d.id}">${name} ¬∑ ${d.status}</option>`;
  }).join("");
  openModal("Nouvelle t√¢che", `
    <label>Titre</label><input id="t_title" placeholder="Ex: Relancer RH‚Ä¶">
    <div class="three">
      <div><label>√âch√©ance</label><input id="t_due" type="date" value="${addDays(7)}"></div>
      <div><label>Priorit√©</label><select id="t_priority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select></div>
      <div><label>Assign√© √†</label><input id="t_assign" value="Vous"></div>
    </div>
    <h2>Associer</h2>
    <div class="three">
      <div><label>Entreprise</label><select id="t_company">${compOpts}</select></div>
      <div><label>Opportunit√©</label><select id="t_deal">${dealOpts}</select></div>
      <div><label>√âtudiant</label><select id="t_student">${stuOpts}</select></div>
    </div>
  `, `<button class="btn primary" onclick="saveTask()">Cr√©er</button>`);
}
async function saveTask(){
  const payload = {
    title: byId('t_title').value || "",
    dueDate: byId('t_due').value || null,
    completed: false,
    assignedTo: byId('t_assign').value || "Vous",
    priority: byId('t_priority').value || "Moyenne",
    companyId: byId('t_company').value || null,
    dealId: byId('t_deal').value || null,
    studentId: byId('t_student').value || null,
  };
  if(!payload.title){ alert("Titre requis"); return; }
  const created = await API.post('tasks', payload);
  if(created?.id){
    if(!db.tasks.find(t=>t.id===created.id)) db.tasks.push(created);
    saveDB();
  }
  closeModal(); route();
}
async function toggleTask(id){
  const t = db.tasks.find(x=>x.id===id); if(!t) return;
  const updated = await API.patch('tasks', { id, completed: !t.completed });
  Object.assign(t, updated); saveDB(); route();
}
async function deleteTask(id){
  if(!confirm("Supprimer cette t√¢che ?")) return;
  await API.del('tasks', { id });
  db.tasks = db.tasks.filter(t=>t.id!==id); saveDB(); route();
}

/* =========================
   HISTORY / INTERACTIONS (API)
========================= */
async function renderHistory(root){
  if(!renderHistory._hydrated){
    try{ const remote = await API.get('interactions'); if(Array.isArray(remote)){ db.interactions = remote; saveDB(); } }
    catch(e){ console.warn('API interactions error', e); }
    renderHistory._hydrated = true;
  }
  const items = [];
  for(const it of db.interactions){
    items.push({date: it.date, type: it.type, content: it.content, companyId: it.companyId, dealId: it.dealId, studentId: it.studentId});
  }
  for(const s of db.students){
    if(s.coaching?.lastUpdate){
      items.push({date: s.coaching.lastUpdate, type:"MAJ Coaching", content:`MAJ progr√®s pour ${s.name}`, studentId: s.id});
    }
  }
  items.sort((a,b)=> (a.date||"").localeCompare(b.date||"")).reverse();
  root.innerHTML = `
    <div class="toolbar">
      <div></div>
      <div><button class="btn" onclick="openAddInteraction()">+ Nouvelle interaction</button></div>
    </div>
    <div class="card">
      ${items.length? items.map(x=>historyLine(x)).join("") : `<div class="empty">Aucun √©v√©nement</div>`}
    </div>
  `;
}
function historyLine(x){
  let link = "";
  if(x.companyId){ const c = companyById(x.companyId); link += ` ¬∑ Entreprise: ${c?c.name:"‚Äî"}`; }
  if(x.dealId){ const d = dealById(x.dealId); const c = d?companyById(d.companyId):null; link += ` ¬∑ Opportunit√©: ${c?c.name:"‚Äî"}`; }
  if(x.studentId){ const s = studentById(x.studentId); link += ` ¬∑ √âtudiant: ${s?s.name:"‚Äî"}`; }
  return `<div style="padding:10px 6px; border-bottom:1px dashed rgba(255,255,255,.07)">
    <strong>${x.type||"Interaction"}</strong> <span class="muted">(${x.date||"‚Äî"})</span> ‚Äî <span>${x.content||""}</span>
    <span class="muted">${link}</span>
  </div>`;
}
function openAddInteraction(companyId){
  const compOpts = `<option value="">‚Äî</option>` + db.companies.map(c=>`<option value="${c.id}" ${companyId===c.id?'selected':''}>${c.name}</option>`).join("");
  const stuOpts  = `<option value="">‚Äî</option>` + db.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  const dealOpts = `<option value="">‚Äî</option>` + db.deals.map(d=>{
    const name = companyById(d.companyId)?.name || "‚Äî";
    return `<option value="${d.id}">${name} ¬∑ ${d.status}</option>`;
  }).join("");
  openModal("Nouvelle interaction", `
    <div class="two">
      <div><label>Date</label><input id="i_date" type="date" value="${today()}"></div>
      <div><label>Type</label><select id="i_type"><option>Appel</option><option>Email</option><option>Rendez-vous</option><option>Visite</option><option>√âv√©nement</option><option>Note interne</option></select></div>
      <div><label>Entreprise</label><select id="i_company">${compOpts}</select></div>
      <div><label>Opportunit√©</label><select id="i_deal">${dealOpts}</select></div>
      <div><label>√âtudiant</label><select id="i_student">${stuOpts}</select></div>
      <div style="grid-column:1/-1"><label>Contenu</label><textarea id="i_content" placeholder="Compte-rendu‚Ä¶"></textarea></div>
    </div>
  `, `<button class="btn primary" onclick="saveInteraction()">Enregistrer</button>`);
}
async function saveInteraction(){
  const payload = {
    date: byId('i_date').value,
    type: byId('i_type').value,
    companyId: byId('i_company').value || null,
    dealId: byId('i_deal').value || null,
    studentId: byId('i_student').value || null,
    content: byId('i_content').value || ""
  };
  const created = await API.post('interactions', payload);
  if(created?.id){
    if(!db.interactions.find(i=>i.id===created.id)) db.interactions.push(created);
    saveDB();
  }
  closeModal(); route();
}

/* =========================
   UI HELPERS
========================= */
function offerCard(o){
  const c = companyById(o.companyId);
  return `<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div><strong>${o.title}</strong> <span class="muted">¬∑ ${o.type||""} ¬∑ ${o.domain||""}</span></div>
      <div>${o.status==="Ouverte"?tag("ok","Ouverte"):tag("warn","Ferm√©e")}</div>
    </div>
    <div class="muted" style="margin-top:6px">${c?c.name:"‚Äî"} ‚Äî D√©but ${o.startDate||"‚Äî"} ¬∑ ${o.spots||0} place(s)</div>
    <div class="row-actions" style="margin-top:8px">
      <button class="btn" onclick="matchStudents('${o.id}')">Matcher</button>
      <button class="btn" onclick="openEditOffer('${o.id}')">√âditer</button>
      <button class="btn" onclick="deleteOffer('${o.id}')">Suppr.</button>
    </div>
  </div>`;
}
function placementLine(p){
  const s = studentById(p.studentId);
  const c = companyById(p.companyId);
  return `<div class="card">
    <strong>${s?s.name:"‚Äî"}</strong> ‚Üí <strong>${c?c.name:"‚Äî"}</strong> ‚Äî ${p.position||""} (${p.contractType||""})<br>
    <span class="muted">${p.startDate||""} ‚Üí ${p.endDate||""}</span>
  </div>`;
}
function openModal(title, bodyHTML, footHTML){
  byId('modalTitle').innerText = title || "";
  byId('modalBody').innerHTML = bodyHTML || "";
  byId('modalFoot').innerHTML = footHTML || "";
  // save last focused element and move focus into modal for accessibility
  try{ window.__lastFocused = document.activeElement; }catch(e){}
  const m = byId('modal'); m.style.display='flex'; m.setAttribute('aria-hidden','false');
  try{ const box = m.querySelector('.box'); if(box) box.focus(); }catch(e){}
}
function closeModal(){
  const m = byId('modal'); m.style.display='none'; m.setAttribute('aria-hidden','true');
  byId('modalTitle').innerText=""; byId('modalBody').innerHTML=""; byId('modalFoot').innerHTML="";
  try{ if(window.__lastFocused && window.__lastFocused.focus) window.__lastFocused.focus(); window.__lastFocused = null; }catch(e){}
}

/* =========================
   EXPORT / IMPORT / RESET
========================= */
function openExportModal(){
  const body = `
    <div class="two">
      <div>
        <label>Export CSV ‚Äî Entit√©s</label>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" onclick="(window.exportCSV || (()=>alert('Export non disponible')) )('students','students.csv')">√âtudiants (CSV)</button>
          <button class="btn" onclick="(window.exportCSV || (()=>alert('Export non disponible')) )('companies','companies.csv')">Entreprises (CSV)</button>
          <button class="btn" onclick="(window.exportCSV || (()=>alert('Export non disponible')) )('offers','offers.csv')">Offres (CSV)</button>
          <button class="btn" onclick="(window.exportCSV || (()=>alert('Export non disponible')) )('deals','deals.csv')">Opportunit√©s (CSV)</button>
          <button class="btn" onclick="(window.exportCSV || (()=>alert('Export non disponible')) )('tasks','tasks.csv')">T√¢ches (CSV)</button>
          <button class="btn" onclick="(window.exportCSV || (()=>alert('Export non disponible')) )('interactions','interactions.csv')">Interactions (CSV)</button>
        </div>
      </div>
      <div>
        <label>Export global</label>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn primary" onclick="(window.exportAllJSON || (()=>{ const data=JSON.stringify(db,null,2); const url=URL.createObjectURL(new Blob([data],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='crm-suivi-export.json'; a.click(); URL.revokeObjectURL(url); }))()">Exporter tout (JSON)</button>
          <div class="muted" style="margin-top:8px">CSV exporte uniquement chaque entit√© en s√©par√© (colonnes top-level ; objets imbriqu√©s s√©rialis√©s).</div>
        </div>
      </div>
    </div>
  `;
  openModal('Export ‚Äî Choix', body, `<button class="btn" onclick="closeModal()">Fermer</button>`);
}
byId('exportBtn').addEventListener('click', openExportModal);
byId('importInput').addEventListener('change', (e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const reader=new FileReader(); reader.onload=ev=>{
    try{ const data=JSON.parse(ev.target.result); if(!data||typeof data!=="object") throw new Error("Fichier invalide");
      db=data; saveDB(); route(); alert("Import termin√©.");
    }catch(err){ alert("Erreur d‚Äôimport: "+err.message); }
  }; reader.readAsText(file);
});
byId('resetBtn').addEventListener('click', ()=>{
  if(!confirm("R√©initialiser toutes les donn√©es locales ?")) return;
  db=defaultDB(); saveDB(); route();
});

/* =========================
   INIT
========================= */
renderNav(); route();
</script>
</body>
</html>
